<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>FPL CAFE — Live Bonus & Stats</title>
  <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;700;900&display=swap" rel="stylesheet">
  <style>
    :root{--bg:#0b0e14;--card:#121621;--border:#1e2433;--ink:#e6e6e6;--muted:#9aa4b2;--accent:#2f7;}
    *{box-sizing:border-box}
    body{font-family:'Tajawal',system-ui,-apple-system,Segoe UI,Roboto,Arial;background:var(--bg);color:var(--ink);margin:0;}
    header{position:sticky;top:0;background:linear-gradient(180deg,rgba(11,14,20,.95),rgba(11,14,20,.7));backdrop-filter:blur(6px);
           border-bottom:1px solid var(--border);padding:12px 16px;z-index:5;}
    .wrap{max-width:1200px;margin:0 auto;}
    h1{margin:0;font-size:28px;color:var(--accent);font-weight:900;}
    .subtitle{font-size:14px;color:var(--muted);margin-bottom:8px;}
    .controls{display:flex;gap:10px;align-items:center;flex-wrap:wrap;margin-top:8px}
    input,button{padding:8px 10px;border:1px solid var(--border);background:#151923;color:var(--ink);border-radius:10px}
    button{cursor:pointer}
    .status{font-size:12px;color:var(--muted)}
    main{padding:16px}
    .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(380px,1fr));gap:14px}
    .card{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:12px}
    .fixture-head{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}
    .teams{font-weight:800}
    .kickoff{font-size:12px;color:var(--muted)}
    .pill{font-size:12px;padding:2px 10px;border-radius:999px;border:1px solid var(--border)}
    .pill.live{border-color:var(--accent);}
    table{width:100%;border-collapse:collapse;table-layout:fixed}
    th,td{padding:6px 8px;border-bottom:1px dashed #23293b;font-size:13px;vertical-align:middle;text-align:center;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    td:first-child, th:first-child{ text-align:right }
    .bonus{font-weight:800}
    .muted{color:var(--muted)}
    .tag{font-size:11px;border:1px solid #2a3247;border-radius:999px;padding:1px 6px;margin-left:4px}
    .cap{border-color:#ffd54f;color:#ffd54f}
    .vc{border-color:#81d4fa;color:#81d4fa}
    .hi{color:#2f7;font-weight:700}
  </style>
</head>
<body>
  <header>
    <div class="wrap">
      <h1>FPL CAFE</h1>
      <div class="subtitle">by: gaiore</div>
      <div class="controls">
        <label>الجولة: <input id="gw" type="number" min="1" max="38" value="1"></label>
        <label>Team ID: <input id="teamId" type="number" min="1" value="159748" style="width:120px"></label>
        <button id="applyTeam">تطبيق الفريق</button>
        <button id="refresh">تحديث الآن</button>
        <span id="status" class="status"></span>
      </div>
    </div>
  </header>

  <main class="wrap">
    <div id="legend" class="muted" style="margin-bottom:10px"></div>
    <div id="fixtures" class="grid"></div>
  </main>

  <script>
    let TEAM_ID = Number(localStorage.getItem('TEAM_ID') || 159748);

    const $gw = document.getElementById('gw');
    const $fixtures = document.getElementById('fixtures');
    const $status = document.getElementById('status');
    const $legend = document.getElementById('legend');
    const $teamId = document.getElementById('teamId');
    const $applyTeam = document.getElementById('applyTeam');

    $teamId.value = TEAM_ID;

    let BOOT;
    const sleep = ms => new Promise(r => setTimeout(r, ms));

    async function j(url){ const r=await fetch(url); if(!r.ok) throw new Error('HTTP '+r.status); return r.json(); }
    function idMap(arr){ const m=new Map(); for(const x of arr) m.set(x.id,x); return m; }
    function teamShort(BOOT,id){ return BOOT.teams.find(t=>t.id===id)?.short_name||'?'; }
    function getPos(elementsById, elId){ const p=elementsById.get(elId); return p ? p.element_type : null; } // 1 GK, 2 DEF, 3 MID, 4 FWD
    function computeBonus(bpsList){
      const sorted=[...bpsList].sort((a,b)=>b.bps-a.bps).slice(0,10);
      if(!sorted.length) return {};
      const byBps={}; for(const x of sorted) (byBps[x.bps] ||= []).push(x.element);
      const uniq=Object.keys(byBps).map(Number).sort((a,b)=>b-a);
      const awards={}; let slots=[3,2,1];
      for(let i=0;i<uniq.length && slots.length;i++){
        const pts = slots.shift();
        for(const el of byBps[uniq[i]]) awards[el] = (awards[el]||0) + pts;
      }
      return awards;
    }

    // Match FPL web_name to PL full name (rough match: last name & first initial)
    function norm(s){ return (s||'').toLowerCase().replace(/[^a-z]/g,''); }
    function matchPlayer(fplName, plName){
      const fn = norm(fplName);
      const parts = (plName||'').split(' ').filter(Boolean);
      if (parts.length === 0) return false;
      const last = norm(parts[parts.length-1]);
      const first = norm(parts[0])[0] || '';
      return (fn === last) || (fn && last.startsWith(fn)) || (fn && (fn[0] === first && last.includes(fn.slice(1))));
    }

    async function getMyPicks(gw){
      try { return await j(`/api/entry/${TEAM_ID}/event/${gw}/picks`); }
      catch(e){
        try{
          const hist=await j(`/api/entry/${TEAM_ID}/history`);
          const lastFinished=(hist?.current||[]).reverse().find(x=>x.finished===true)||(hist?.current||[])[0];
          if(lastFinished) return await j(`/api/entry/${TEAM_ID}/event/${lastFinished.event}/picks`);
        }catch(_){}
      }
      return null;
    }

    async function render(){
      $status.textContent='جارِ التحديث…';
      try{
        if(!BOOT){ BOOT = await j('/api/bootstrap'); }
        const elementsById=idMap(BOOT.elements);
        const currentGW = BOOT.events.find(e=>e.is_current)?.id || BOOT.events.find(e=>!e.finished)?.id || 1;
        if(!$gw.dataset.init){ $gw.value=currentGW; $gw.dataset.init='1'; }
        const gw = Number($gw.value);

        const [fixtures, live, picks] = await Promise.all([
          j(`/api/fixtures?event=${gw}`),
          j(`/api/live/${gw}`),
          getMyPicks(gw)
        ]);

        $legend.innerHTML = `الفريق النشط: <b>${TEAM_ID}</b> — الجولة: <b>${gw}</b>`;

        // explain not needed for PL stats, just need bps & fixture mapping
        const bpsByFixture = {};
        if(Array.isArray(live.elements)){
          for(const el of live.elements){
            const elId = el.id;
            const bps = el.stats?.bps ?? 0;
            const fixtureId = el.explain?.[0]?.fixture || null;
            if(!fixtureId) continue;
            (bpsByFixture[fixtureId] ||= []).push({ element: elId, bps });
          }
        }

        // Build map fixtureId -> pulse_id
        const pulseByFixtureId = {};
        for(const fx of fixtures){ if(fx.id && fx.pulse_id) pulseByFixtureId[fx.id] = fx.pulse_id; }

        $fixtures.innerHTML='';
        const fr=document.createDocumentFragment();

        for (const f of fixtures) {
          const fxId=f.id;
          const pulseId = pulseByFixtureId[fxId];
          const home=teamShort(BOOT,f.team_h);
          const away=teamShort(BOOT,f.team_a);
          const ko=f.kickoff_time ? new Date(f.kickoff_time).toLocaleString() : '—';

          const bpsList=(bpsByFixture[fxId]||[]).sort((a,b)=>b.bps-a.bps).slice(0,12);
          const bonus=computeBonus(bpsList);

          // Fetch PL stats
          let plPlayers = [];
          if (pulseId) {
            try {
              const pl = await j(`/api/pl/match/${pulseId}`);
              const pushPlayers = (arr) => {
                for (const p of (arr||[])) {
                  const name = p.name || p.player?.name || p.playerName || '';
                  const s = p.stats || p.s || {};
                  const get = (k) => Number((s[k]?.value ?? s[k] ?? 0));
                  plPlayers.push({
                    name,
                    stats: {
                      clearances: get('clearances'),
                      blocks: get('blocks'),
                      interceptions: get('interceptions'),
                      clearances_blocks_interceptions: get('clearances_blocks_interceptions') || (get('clearances')+get('blocks')+get('interceptions')),
                      tackles: get('tackles'),
                      recoveries: get('recoveries'),
                    }
                  });
                }
              };
              if (pl?.entity) {
                pushPlayers(pl.entity?.home?.players);
                pushPlayers(pl.entity?.away?.players);
              }
              if (pl?.players) pushPlayers(pl.players);
              if (pl?.homeTeam?.players) pushPlayers(pl.homeTeam.players);
              if (pl?.awayTeam?.players) pushPlayers(pl.awayTeam.players);
              if (pl?.stats?.players) pushPlayers(pl.stats.players);
            } catch(e) { console.warn('PL fetch failed', pulseId, e); }
          }
          const plMap = new Map(plPlayers.map(p => [p.name, p.stats]));

          const thead = `
            <thead>
              <tr>
                <th>اللاعب</th>
                <th>BPS</th><th>Bonus</th>
                <th>Clea</th><th>Blk</th><th>Int/CBI</th><th>Tack</th><th>Recv</th>
                <th>Total</th><th>Defcon</th>
              </tr>
            </thead>`;

          const rows = bpsList.map(row=>{
            const p = elementsById.get(row.element);
            const name = p ? p.web_name : `#${row.element}`;
            const pos = p ? p.element_type : null;

            let foundStats = null;
            for (const [plName, s] of plMap.entries()) { if (matchPlayer(name, plName)) { foundStats = s; break; } }
            const s = foundStats || {clearances:0,blocks:0,interceptions:0,clearances_blocks_interceptions:0,tackles:0,recoveries:0};

            let total, defcon;
            if (pos===1 || pos===2) { // DEF/GK
              total = s.clearances + s.blocks + s.interceptions + s.tackles;
              defcon = total >= 10 ? 2 : '';
            } else { // MID/FWD
              const cbi = s.clearances_blocks_interceptions || (s.clearances + s.blocks + s.interceptions);
              total = s.clearances + s.blocks + cbi + s.tackles + s.recoveries;
              defcon = total >= 12 ? 2 : '';
            }
            const intOrCbi = (pos===1||pos===2) ? s.interceptions : (s.clearances_blocks_interceptions || (s.clearances+s.blocks+s.interceptions));
            const recv = (pos===3||pos===4) ? s.recoveries : '';

            const mine = picks?.picks?.some(px=>px.element===row.element);
            const isC = picks?.picks?.some(px=>px.element===row.element && (px.is_captain||px.multiplier===2));
            const isVC= picks?.picks?.some(px=>px.element===row.element && px.is_vice_captain);
            const tags=[];
            if(mine) tags.push('<span class="tag">فريقي</span>');
            if(isC)  tags.push('<span class="tag cap">C</span>');
            if(isVC) tags.push('<span class="tag vc">VC</span>');

            return `
              <tr>
                <td style="text-align:right">${name} ${tags.join(' ')}</td>
                <td>${row.bps}</td><td class="bonus">${bonus[row.element]||0}</td>
                <td>${s.clearances||0}</td>
                <td>${s.blocks||0}</td>
                <td>${intOrCbi||0}</td>
                <td>${s.tackles||0}</td>
                <td>${recv||0}</td>
                <td class="${total? 'hi':''}">${total||0}</td>
                <td>${defcon||''}</td>
              </tr>`;
          }).join('');

          const card=document.createElement('div');
          card.className='card';
          card.innerHTML=`
            <div class="fixture-head">
              <div>
                <div class="teams">${home} vs ${away}</div>
                <div class="kickoff">${ko}</div>
              </div>
              <div class="pill ${f.started ? 'live' : ''}">${f.started ? 'LIVE' : 'Scheduled'}</div>
            </div>
            <table>${thead}<tbody>${rows}</tbody></table>`;
          fr.appendChild(card);
        }

        $fixtures.appendChild(fr);
        $status.textContent = 'آخر تحديث: '+new Date().toLocaleTimeString();
      }catch(err){
        console.error(err);
        $status.textContent='تعذر الجلب — حاول مجددًا';
      }
    }

    document.getElementById('refresh').addEventListener('click', render);
    $applyTeam.addEventListener('click', ()=>{
      const v = Number($teamId.value);
      if(!v) return;
      TEAM_ID = v;
      localStorage.setItem('TEAM_ID', String(v));
      render();
    });

    render();
    (async function loop(){ while(true){ await sleep(30000); await render(); } })();
  </script>
</body>
</html>
