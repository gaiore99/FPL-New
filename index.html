<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>FPL CAFE — Live Bonus & Defcon</title>
  <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;700;900&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg:#0b0e14;--card:#111525;--border:#1e2537;--ink:#f2f5f9;--muted:#a9b3c3;--accent:#2fff88;--warn:#ffd54f;
    }
    *{box-sizing:border-box}
    body{font-family:'Tajawal',system-ui,-apple-system,Segoe UI,Roboto,Arial;background:var(--bg);color:var(--ink);margin:0;}
    header{
      position:sticky;top:0;background:linear-gradient(180deg,rgba(11,14,20,.97),rgba(11,14,20,.80));
      backdrop-filter:blur(6px);border-bottom:1px solid var(--border);padding:14px 16px;z-index:5;
    }
    .wrap{max-width:1220px;margin:0 auto;}
    h1{margin:0;font-size:30px;color:var(--accent);font-weight:900;letter-spacing:.5px}
    .subtitle{font-size:14px;color:var(--muted);margin-top:2px}
    .controls{display:flex;gap:10px;align-items:center;flex-wrap:wrap;margin-top:10px}
    input,button{padding:9px 12px;border:1px solid var(--border);background:#141a2b;color:var(--ink);border-radius:10px;font-size:14px}
    button{cursor:pointer}
    .status{font-size:13px;color:var(--muted)}
    main{padding:16px}
    .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(380px,1fr));gap:16px}
    .card{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:12px}
    .fixture-head{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}
    .teams{font-weight:800;font-size:16px}
    .kickoff{font-size:12px;color:var(--muted)}
    .pill{font-size:12px;padding:2px 10px;border-radius:999px;border:1px solid var(--border)}
    .pill.live{border-color:var(--accent)}
    table{width:100%;border-collapse:collapse;table-layout:fixed}
    thead th{
      position:sticky;top:0;background:var(--card);z-index:1;
      font-size:13.5px;color:#dfe6f3;border-bottom:1px solid #263049;padding:7px 6px
    }
    tbody td{padding:8px 6px;border-bottom:1px dashed #263049;font-size:14px;vertical-align:middle;text-align:center;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    td:first-child, th:first-child{text-align:right}
    .bonus{font-weight:800}
    .muted{color:var(--muted)}
    .tag{font-size:11px;border:1px solid #2a3247;border-radius:999px;padding:1px 6px;margin-left:4px}
    .cap{border-color:var(--warn);color:var(--warn)}
    .vc{border-color:#81d4fa;color:#81d4fa}
    .hi{color:var(--accent);font-weight:800}
    .legend{color:var(--muted);font-size:13px;margin-bottom:8px}
    .defcell{font-weight:800}
  </style>
</head>
<body>
  <header>
    <div class="wrap">
      <h1>FPL CAFE</h1>
      <div class="subtitle">by: gaiore</div>
      <div class="controls">
        <label>الجولة: <input id="gw" type="number" min="1" max="38" value="1"></label>
        <label>Team ID: <input id="teamId" type="number" min="1" value="159748" style="width:130px"></label>
        <button id="applyTeam">تطبيق الفريق</button>
        <button id="refresh">تحديث الآن</button>
        <span id="status" class="status"></span>
      </div>
    </div>
  </header>

  <main class="wrap">
    <div id="legend" class="legend"></div>
    <div id="fixtures" class="grid"></div>
  </main>

  <script>
    // ===== State & helpers =====
    let TEAM_ID = Number(localStorage.getItem('TEAM_ID') || 159748);

    const $gw = document.getElementById('gw');
    const $fixtures = document.getElementById('fixtures');
    const $status = document.getElementById('status');
    const $legend = document.getElementById('legend');
    const $teamId = document.getElementById('teamId');
    const $applyTeam = document.getElementById('applyTeam');

    $teamId.value = TEAM_ID;

    let BOOT;
    const sleep = ms => new Promise(r => setTimeout(r, ms));

    async function j(url){ const r=await fetch(url); if(!r.ok) throw new Error('HTTP '+r.status); return r.json(); }
    function idMap(arr){ const m=new Map(); for(const x of arr) m.set(x.id,x); return m; }
    function teamShort(BOOT,id){ return BOOT.teams.find(t=>t.id===id)?.short_name||'?'; }
    function getPos(elementsById, elId){ const p=elementsById.get(elId); return p ? p.element_type : null; } // 1 GK, 2 DEF, 3 MID, 4 FWD

    // BPS -> Bonus
    function computeBonus(bpsList){
      const sorted=[...bpsList].sort((a,b)=>b.bps-a.bps).slice(0,10);
      if(!sorted.length) return {};
      const byBps={}; for(const x of sorted) (byBps[x.bps] ||= []).push(x.element);
      const uniq=Object.keys(byBps).map(Number).sort((a,b)=>b-a);
      const awards={}; let slots=[3,2,1];
      for(let i=0;i<uniq.length && slots.length;i++){
        const pts = slots.shift();
        for(const el of byBps[uniq[i]]) awards[el] = (awards[el]||0) + pts;
      }
      return awards;
    }

    async function getMyPicks(gw){
      try { return await j(`/api/entry/${TEAM_ID}/event/${gw}/picks`); }
      catch(e){
        try{
          const hist=await j(`/api/entry/${TEAM_ID}/history`);
          const lastFinished=(hist?.current||[]).reverse().find(x=>x.finished===true)||(hist?.current||[])[0];
          if(lastFinished) return await j(`/api/entry/${TEAM_ID}/event/${lastFinished.event}/picks`);
        }catch(_){}
      }
      return null;
    }

    // ===== Render =====
    async function render(){
      $status.textContent='جارِ التحديث…';
      try{
        if(!BOOT){ BOOT = await j('/api/bootstrap'); }
        const elementsById=idMap(BOOT.elements);
        const currentGW = BOOT.events.find(e=>e.is_current)?.id || BOOT.events.find(e=>!e.finished)?.id || 1;
        if(!$gw.dataset.init){ $gw.value=currentGW; $gw.dataset.init='1'; }
        const gw = Number($gw.value);

        const [fixtures, live, picks] = await Promise.all([
          j(`/api/fixtures?event=${gw}`),
          j(`/api/live/${gw}`),
          getMyPicks(gw)
        ]);

        $legend.innerHTML = `الفريق النشط: <b>${TEAM_ID}</b> — الجولة: <b>${gw}</b> &nbsp;|&nbsp; <span class="muted">يعرض Defcon من FPL (defensive_contribution).</span>`;

        // bpsByFixture من live.elements (لسرد اللاعبين وترتيبهم)
        const bpsByFixture = {};
        if(Array.isArray(live.elements)){
          for(const el of live.elements){
            const elId = el.id;
            const bps = el.stats?.bps ?? 0;
            const fixtureId = el.explain?.[0]?.fixture || null;
            if(!fixtureId) continue;
            (bpsByFixture[fixtureId] ||= []).push({ element: elId, bps });
          }
        }

        $fixtures.innerHTML='';
        const fr=document.createDocumentFragment();

        for (const f of fixtures) {
          const fxId = f.id;
          const home = teamShort(BOOT,f.team_h);
          const away = teamShort(BOOT,f.team_a);
          const ko   = f.kickoff_time ? new Date(f.kickoff_time).toLocaleString() : '—';

          const bpsList = (bpsByFixture[fxId] || []).sort((a,b)=>b.bps-a.bps).slice(0,12);
          const bonus = computeBonus(bpsList);

          // Defcon من FPL: defensive_contribution لهذه المباراة
          const dcMap = new Map();
          const dcStat = (f.stats || []).find(s => (s.identifier || '').toLowerCase().includes('defensive_contribution'));
          if (dcStat) {
            for (const side of ['a','h']) for (const ent of (dcStat[side] || [])) {
              if (ent && ent.element != null) dcMap.set(ent.element, Number(ent.value || 0));
            }
          }

          // رأس الجدول (مختصر)
          const thead = `
            <thead>
              <tr>
                <th>اللاعب</th>
                <th>BPS</th>
                <th>Bonus</th>
                <th>Defcon</th>
              </tr>
            </thead>`;

          const rows = bpsList.map(row=>{
            const el = elementsById.get(row.element);
            const name = el ? el.web_name : `#${row.element}`;
            const pos  = el ? el.element_type : null; // 1 GK, 2 DEF, 3 MID, 4 FWD
            const def  = Number(dcMap.get(row.element) || 0);

            // تمييز بصري عندما يتجاوز العتبة
            const isHigh = (pos===1 || pos===2) ? (def>=10) : (def>=12);

            // وسوم فريقي/الكابتن/الڤايس
            const mine = picks?.picks?.some(px=>px.element===row.element);
            const isC  = picks?.picks?.some(px=>px.element===row.element && (px.is_captain||px.multiplier===2));
            const isVC = picks?.picks?.some(px=>px.element===row.element && px.is_vice_captain);
            const tags = [];
            if (mine) tags.push('<span class="tag">فريقي</span>');
            if (isC)  tags.push('<span class="tag cap">C</span>');
            if (isVC) tags.push('<span class="tag vc">VC</span>');

            return `
              <tr>
                <td style="text-align:right">${name} ${tags.join(' ')}</td>
                <td>${row.bps}</td>
                <td class="bonus">${(bonus[row.element]||0)}</td>
                <td class="defcell ${isHigh?'hi':''}">${def}</td>
              </tr>`;
          }).join('');

          const card = document.createElement('div');
          card.className = 'card';
          card.innerHTML = `
            <div class="fixture-head">
              <div>
                <div class="teams">${home} vs ${away}</div>
                <div class="kickoff">${ko}</div>
              </div>
              <div class="pill ${f.started ? 'live' : ''}">${f.started ? 'LIVE' : 'Scheduled'}</div>
            </div>
            <table>${thead}<tbody>${rows}</tbody></table>`;
          fr.appendChild(card);
        }

        $fixtures.appendChild(fr);
        $status.textContent = 'آخر تحديث: '+new Date().toLocaleTimeString();
      }catch(err){
        console.error(err);
        $status.textContent='تعذر الجلب — حاول مجددًا';
      }
    }

    // ===== Events =====
    document.getElementById('refresh').addEventListener('click', render);
    $applyTeam.addEventListener('click', ()=>{
      const v = Number($teamId.value);
      if(!v) return;
      TEAM_ID = v;
      localStorage.setItem('TEAM_ID', String(v));
      render();
    });

    // ===== Boot =====
    render();
    (async function loop(){ while(true){ await sleep(30000); await render(); } })();
  </script>
</body>
</html>
